p8105_hw6_wm2460
================

## Problem 1

``` r
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

## Problem 2

### Tidying the dataset

``` r
homicides_df = read_csv("./data/homicide-data.csv")

homicides_new = homicides_df %>% 
  janitor::clean_names() %>% 
  mutate(city_state = str_c(city, state, sep = "_")) %>% 
  filter(!city_state %in% c("Dallas_TX", "Phoenix_AZ", "Kansas City_MO", "Tulsa_AL"), 
         victim_race %in% c("Black", "White")) %>% 
  mutate(victim_age = as.numeric(victim_age),
         resolved = as.numeric(disposition == "Closed by arrest"),
         victim_race = fct_relevel(victim_race, "White"),
         victim_sex = fct_relevel(victim_sex, "Female"))
```

### `glm` for Baltimore

``` r
baltimore_glm = homicides_new %>% 
  filter(city_state == "Baltimore_MD") %>% 
  glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial()) %>% 
  broom::tidy()

baltimore_glm
```

    ## # A tibble: 4 × 5
    ##   term             estimate std.error statistic  p.value
    ##   <chr>               <dbl>     <dbl>     <dbl>    <dbl>
    ## 1 (Intercept)       1.15      0.237        4.87 1.14e- 6
    ## 2 victim_age       -0.00673   0.00332     -2.02 4.30e- 2
    ## 3 victim_sexMale   -0.854     0.138       -6.18 6.26e-10
    ## 4 victim_raceBlack -0.842     0.175       -4.82 1.45e- 6

### Adjusted odds ratio for Baltimore

``` r
baltimore_glm %>% 
  mutate(OR = exp(estimate),
         CI_upper = exp(estimate + 1.96 * std.error),
         CI_lower = exp(estimate - 1.96 * std.error)) %>%
  filter(term == "victim_sexMale") %>%
  select(term, OR, CI_upper, CI_lower) %>% 
  knitr::kable(digits = 3)
```

| term           |    OR | CI_upper | CI_lower |
|:---------------|------:|---------:|---------:|
| victim_sexMale | 0.426 |    0.558 |    0.325 |

### `glm` and adjusted odds ratio for all cities

``` r
all_glm = homicides_new %>% 
  nest(all_cities = -city_state) %>%
  mutate(models = map(.x = all_cities, ~glm(resolved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())),
         results = map(models, broom::tidy)) %>% 
  select(-models, -all_cities) %>% 
  unnest(cols = results) %>% 
  mutate(OR = exp(estimate),
         CI_upper = exp(estimate + 1.96 * std.error),
         CI_lower = exp(estimate - 1.96 * std.error)) %>% 
  filter(term == "victim_sexMale") %>% 
  select(city_state, OR, CI_upper, CI_lower)

all_glm %>% 
  knitr::kable(digits = 3)
```

| city_state        |    OR | CI_upper | CI_lower |
|:------------------|------:|---------:|---------:|
| Albuquerque_NM    | 1.767 |    3.761 |    0.831 |
| Atlanta_GA        | 1.000 |    1.463 |    0.684 |
| Baltimore_MD      | 0.426 |    0.558 |    0.325 |
| Baton Rouge_LA    | 0.381 |    0.695 |    0.209 |
| Birmingham_AL     | 0.870 |    1.318 |    0.574 |
| Boston_MA         | 0.674 |    1.276 |    0.356 |
| Buffalo_NY        | 0.521 |    0.935 |    0.290 |
| Charlotte_NC      | 0.884 |    1.403 |    0.557 |
| Chicago_IL        | 0.410 |    0.501 |    0.336 |
| Cincinnati_OH     | 0.400 |    0.677 |    0.236 |
| Columbus_OH       | 0.532 |    0.750 |    0.378 |
| Denver_CO         | 0.479 |    0.971 |    0.236 |
| Detroit_MI        | 0.582 |    0.734 |    0.462 |
| Durham_NC         | 0.812 |    1.683 |    0.392 |
| Fort Worth_TX     | 0.669 |    1.127 |    0.397 |
| Fresno_CA         | 1.335 |    3.071 |    0.580 |
| Houston_TX        | 0.711 |    0.907 |    0.558 |
| Indianapolis_IN   | 0.919 |    1.242 |    0.679 |
| Jacksonville_FL   | 0.720 |    0.966 |    0.537 |
| Las Vegas_NV      | 0.837 |    1.154 |    0.608 |
| Long Beach_CA     | 0.410 |    1.082 |    0.156 |
| Los Angeles_CA    | 0.662 |    0.956 |    0.458 |
| Louisville_KY     | 0.491 |    0.790 |    0.305 |
| Memphis_TN        | 0.723 |    0.988 |    0.529 |
| Miami_FL          | 0.515 |    0.872 |    0.304 |
| Milwaukee_wI      | 0.727 |    1.060 |    0.499 |
| Minneapolis_MN    | 0.947 |    1.875 |    0.478 |
| Nashville_TN      | 1.034 |    1.562 |    0.685 |
| New Orleans_LA    | 0.585 |    0.811 |    0.422 |
| New York_NY       | 0.262 |    0.499 |    0.138 |
| Oakland_CA        | 0.563 |    0.868 |    0.365 |
| Oklahoma City_OK  | 0.974 |    1.520 |    0.624 |
| Omaha_NE          | 0.382 |    0.721 |    0.203 |
| Philadelphia_PA   | 0.496 |    0.652 |    0.378 |
| Pittsburgh_PA     | 0.431 |    0.700 |    0.265 |
| Richmond_VA       | 1.006 |    2.033 |    0.498 |
| San Antonio_TX    | 0.705 |    1.249 |    0.398 |
| Sacramento_CA     | 0.669 |    1.337 |    0.335 |
| Savannah_GA       | 0.867 |    1.780 |    0.422 |
| San Bernardino_CA | 0.500 |    1.462 |    0.171 |
| San Diego_CA      | 0.413 |    0.855 |    0.200 |
| San Francisco_CA  | 0.608 |    1.165 |    0.317 |
| St. Louis_MO      | 0.703 |    0.932 |    0.530 |
| Stockton_CA       | 1.352 |    2.942 |    0.621 |
| Tampa_FL          | 0.808 |    1.876 |    0.348 |
| Tulsa_OK          | 0.976 |    1.552 |    0.614 |
| Washington_DC     | 0.690 |    1.017 |    0.468 |

### Plot for adjusted OR and 95% CI

``` r
or_plot = all_glm %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  ylim(0, 4) +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

or_plot
```

<img src="p8105_hw6_wm2460_files/figure-gfm/plot_or-1.png" width="90%" />

Comment on the plot: Here, we can see that New York has the lowest
adjusted odds ratio and Albuquerque has the highest adjusted odds ratio.
Since many cities have odds ratio below 1, the odds of having a resolved
homicide when the victim is male is usually lower than the odds of
having a resolved homicide when the victim was female in many cities,
after adjusting for victim age and victim race. The 95% CI of Fresno,
Stockton, and Albuquerque is much wider than other cities.

## Problem 3

### Load and clearn

``` r
bw_df = read_csv("./data/birthweight.csv")
```

    ## Rows: 4342 Columns: 20
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## dbl (20): babysex, bhead, blength, bwt, delwt, fincome, frace, gaweeks, malf...
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

``` r
bw_new = bw_df %>% 
  mutate(babysex = as.factor(babysex),
         frace = as.factor(frace),
         malform = as.factor(malform),
         mrace = as.factor(mrace)) 

sum(is.na(bw_new))
```

    ## [1] 0

Cleaned the dataset and there is no missing data since
`sum(is.na(bw_new))` returns 0.

### Model 1

``` r
m1 = lm(bwt ~ wtgain, data = bw_new)

m1_df = bw_new %>% 
  select(bwt, wtgain) %>% 
  modelr::add_residuals(m1) %>% 
  modelr::add_predictions(m1)

m1_df %>% 
  ggplot(aes(x = wtgain, y = resid)) + geom_violin()
```

<img src="p8105_hw6_wm2460_files/figure-gfm/m1-1.png" width="90%" />

I picked the variable `wtgain` as the predictor for model 1 and I picked
it based on a hypothesized structure for the factors that underly
birthweight.

The residual plot shows that the residual of `wtgain` is approximately
normally distributed following the central limit theorem.

## Model 2 & 3

``` r
m2 = lm(bwt ~ blength + gaweeks, data = bw_new)

m3 = lm(bwt ~ bhead + blength + babysex + bhead*blength + bhead*babysex + blength*babysex + bhead*blength*babysex, data = bw_new)
```

## Crossvalidation

``` r
bw_cv = crossv_mc(bw_new, 100) %>% 
  mutate(train = map(train, as_tibble),
         test = map(test, as_tibble)) %>% 
  mutate(m1_cv = map(train, ~lm(bwt ~ wtgain, data = .x)),
         m2_cv = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
         m3_cv = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead*blength + bhead*babysex + blength*babysex + bhead*blength*babysex, data = .x))) %>% 
  mutate(rmse_m1 = map2_dbl(m1_cv, test, ~rmse(model = .x, data = .y)),
         rmse_m2 = map2_dbl(m2_cv, test, ~rmse(model = .x, data = .y)), 
         rmse_m3 = map2_dbl(m3_cv, test, ~rmse(model = .x, data = .y)))

bw_cv_plot = bw_cv %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(everything(), 
               names_to = "model",
               values_to = "rmse",
               names_prefix = "rmse_") %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()

bw_cv_plot
```

<img src="p8105_hw6_wm2460_files/figure-gfm/cv-1.png" width="90%" />

From the violin plot, we can see that model 1 has the highest RMSE and
model 3 has the lowest RMSE. Since it is preferable to select the model
with the smallest RMSE, model 3 is better comparing to the other two
models.

## End of HW6
